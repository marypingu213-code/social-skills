<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾æœƒæŠ€å·§èª²ï¼šæµ£ç†Šçš„æˆ¿é–“</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            overflow: hidden; 
        }
        .slide-wrapper {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e2e8f0;
            padding: 10px;
            box-sizing: border-box;
        }
        .slide-container {
            width: 100%;
            max-width: 1600px; /* åŠ å¯¬ç‰ˆé¢ */
            height: 100%;
            max-height: 95vh; 
            aspect-ratio: 16/9;
            background: white;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.25);
            border-radius: 24px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            width: 100%;
        }
        /* å¹³æ¿æ¨¡å¼å°ˆç”¨æ¨£å¼ */
        .tablet-mode-container {
            width: 100vw;
            height: 100vh;
            background-color: #fce7f3; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .animate-bounce-slow {
            animation: bounce 2s infinite;
        }
        @keyframes stamp {
            0% { opacity: 0; transform: scale(5); }
            100% { opacity: 1; transform: scale(1); }
        }
        .stamp-animation {
            animation: stamp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // =========================================================================
        // ã€è€å¸«çš„ Firebase è¨­å®šã€‘
        // =========================================================================
        const TEACHER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDhwu9YAyfMxZtC5BhGKzmVyxWdQ4qW3MM",
            authDomain: "social-89bcb.firebaseapp.com",
            projectId: "social-89bcb",
            storageBucket: "social-89bcb.firebasestorage.app",
            messagingSenderId: "638955050705",
            appId: "1:638955050705:web:aec1eb12e9142c9a7ad7f0",
            measurementId: "G-CG8V25F05H"
        };
        // =========================================================================

        const getFirebaseConfig = () => {
            if (TEACHER_FIREBASE_CONFIG) return TEACHER_FIREBASE_CONFIG;
            try {
                if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
            } catch (e) { console.warn("No preview config found"); }
            return null;
        };

        const firebaseConfig = getFirebaseConfig();
        let db = null;
        let auth = null;
        const appId = firebaseConfig ? firebaseConfig.projectId : 'classroom-raccoon-001';
        
        if (firebaseConfig && firebase.apps.length === 0) {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                console.log("Firebase initialized.");
            } catch(e) {
                console.error("Firebase init error", e);
            }
        }

        const STUDENT_NAMES = ["ç‘€å®‰", "æ‰¿ç†™", "æ›¸æ„·", "å²·ç¿°", "ç¿ç©", "å®‡è»’", "æ¥·å…ƒ", "å®ˆæ©"];

        // é è¨­è³‡æ–™
        const MOCK_STUDENTS = STUDENT_NAMES.map((name, index) => ({
            id: name,
            name: name,
            order: index,
            checks: { eyes: false, hand: false, mouth: false },
            submitted: false,
            completed: false
        }));

        const App = () => {
            const [currentSlide, setCurrentSlide] = useState(0);
            const [lightStatus, setLightStatus] = useState('red');
            const [user, setUser] = useState(null);
            const [students, setStudents] = useState(MOCK_STUDENTS);
            const [isTabletMode, setIsTabletMode] = useState(false);
            const [selectedStudentId, setSelectedStudentId] = useState(null);
            const [isOfflineMode, setIsOfflineMode] = useState(!db); 
            const [isLocalFile, setIsLocalFile] = useState(false);
            const [loadingError, setLoadingError] = useState("");

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('mode') === 'student') setIsTabletMode(true);
                if (window.location.protocol === 'file:') {
                    setIsLocalFile(true);
                    setIsOfflineMode(true);
                }
            }, []);

            useEffect(() => {
                if (!db) {
                    const savedData = localStorage.getItem('local_students_data');
                    if (savedData) setStudents(JSON.parse(savedData));
                    return;
                }

                const initAuth = async () => {
                    try {
                        setLoadingError("");
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) {
                        console.error("Auth error:", e);
                        if (e.code === 'auth/operation-not-allowed') {
                            setLoadingError("éŒ¯èª¤ï¼šè«‹åˆ° Firebase Console é–‹å•Ÿã€ŒåŒ¿åç™»å…¥ã€");
                        } else {
                            setLoadingError(`é€£ç·šéŒ¯èª¤ (${e.code})`);
                        }
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged(setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;

                const studentsRef = db.collection('artifacts').doc(appId)
                                      .collection('public').doc('data')
                                      .collection('students_session_v1');
                
                const unsubscribe = studentsRef.onSnapshot((snapshot) => {
                    const loadedStudents = [];
                    snapshot.forEach(doc => {
                        loadedStudents.push({ id: doc.id, ...doc.data() });
                    });

                    if (loadedStudents.length > 0) {
                        loadedStudents.sort((a, b) => a.order - b.order);
                        setStudents(loadedStudents);
                        setLoadingError("");
                    } else {
                        initializeStudents(studentsRef);
                    }
                }, (error) => {
                    console.error("Error fetching students:", error);
                    if (error.code === 'permission-denied') {
                        setLoadingError("æ¬Šé™ä¸è¶³ï¼šè«‹æª¢æŸ¥ Firestore è¦å‰‡æ˜¯å¦ç‚ºæ¸¬è©¦æ¨¡å¼");
                    } else {
                        setLoadingError("é€£ç·šä¸­æ–·ï¼Œæ­£åœ¨é‡è©¦...");
                    }
                });

                return () => unsubscribe();
            }, [user]);

            const initializeStudents = async (collectionRef = null) => {
                if (!db) return;
                try {
                    const targetRef = collectionRef || db.collection('artifacts').doc(appId)
                                      .collection('public').doc('data')
                                      .collection('students_session_v1');
                    
                    const batch = db.batch();
                    STUDENT_NAMES.forEach((name, index) => {
                        const docRef = targetRef.doc(name);
                        batch.set(docRef, {
                            name: name,
                            order: index,
                            checks: { eyes: false, hand: false, mouth: false },
                            submitted: false,
                            completed: false
                        });
                    });
                    await batch.commit();
                } catch (e) {
                    console.error("Init failed", e);
                }
            };

            const resetAllStudents = async () => {
                if (!db || !user) return;
                if (!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç”Ÿçš„ç‹€æ…‹å—ï¼Ÿ")) return;
                
                try {
                    const batch = db.batch();
                    const collectionRef = db.collection('artifacts').doc(appId)
                                          .collection('public').doc('data')
                                          .collection('students_session_v1');
                    
                    students.forEach(student => {
                        const docRef = collectionRef.doc(student.id);
                        batch.update(docRef, {
                            checks: { eyes: false, hand: false, mouth: false },
                            submitted: false
                        });
                    });
                    await batch.commit();
                } catch (e) {
                    console.error("Reset failed", e);
                }
            };

            // æ ¸å¿ƒé‚è¼¯ä¿®æ”¹ï¼šæ¨‚è§€æ›´æ–° (å…ˆæ›´æ–°ç•«é¢ï¼Œå†é€è³‡æ–™åº«)
            const updateStudentCheck = async (studentId, checkItem, currentValue) => {
                // 1. é¦¬ä¸Šæ›´æ–°æœ¬åœ°ç•«é¢ï¼Œè®“å­¸ç”Ÿè¦ºå¾—å¾ˆé †
                const nextValue = !currentValue;
                setStudents(prev => prev.map(s => {
                    if (s.id === studentId) {
                        return { ...s, checks: { ...s.checks, [checkItem]: nextValue } };
                    }
                    return s;
                }));

                // 2. èƒŒæ™¯å·å·é€å‡ºè³‡æ–™
                if (db && user) {
                    try {
                        const studentRef = db.collection('artifacts').doc(appId)
                                             .collection('public').doc('data')
                                             .collection('students_session_v1')
                                             .doc(studentId);
                        await studentRef.update({ [`checks.${checkItem}`]: nextValue });
                    } catch (e) {
                        console.error("Sync failed", e);
                        // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦è¦è·³å‡ºéŒ¯èª¤æç¤ºï¼Œæˆ–è€…éœé»˜å¤±æ•—
                    }
                } else {
                    // Offline fallback
                    const newStudents = students.map(s => {
                        if (s.id === studentId) return { ...s, checks: { ...s.checks, [checkItem]: nextValue } };
                        return s;
                    });
                    localStorage.setItem('local_students_data', JSON.stringify(newStudents));
                }
            };

            const submitStudentData = async (studentId, status) => {
                // 1. é¦¬ä¸Šæ›´æ–°ç•«é¢
                setStudents(prev => prev.map(s => {
                    if (s.id === studentId) return { ...s, submitted: status };
                    return s;
                }));

                // 2. èƒŒæ™¯é€å‡º
                if (db && user) {
                    try {
                        const studentRef = db.collection('artifacts').doc(appId)
                                             .collection('public').doc('data')
                                             .collection('students_session_v1')
                                             .doc(studentId);
                        await studentRef.update({ submitted: status });
                    } catch (e) {
                        console.error("Sync failed", e);
                        alert("é€£ç·šä¸ç©©å®šï¼Œè«‹å†æŒ‰ä¸€æ¬¡é€å‡º");
                    }
                } else {
                    const newStudents = students.map(s => {
                        if (s.id === studentId) return { ...s, submitted: status };
                        return s;
                    });
                    localStorage.setItem('local_students_data', JSON.stringify(newStudents));
                }
            };

            const calculateScore = (checks) => Object.values(checks || {}).filter(Boolean).length;

            const totalSlides = 9;
            const nextSlide = () => { if (currentSlide < totalSlides - 1) setCurrentSlide(currentSlide + 1); };
            const prevSlide = () => { if (currentSlide > 0) setCurrentSlide(currentSlide - 1); };

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (isTabletMode) return;
                    if (e.key === 'ArrowRight' || e.key === ' ') nextSlide();
                    if (e.key === 'ArrowLeft') prevSlide();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [currentSlide, isTabletMode]);

            // --- Views ---
            if (isTabletMode) {
                if (selectedStudentId === null) {
                    return (
                        <div className="tablet-mode-container p-8">
                            {loadingError && <div className="text-center bg-red-100 p-4 text-red-600 font-bold mb-4 rounded-xl border-2 border-red-300 whitespace-pre-line">{loadingError}</div>}
                            <h1 className="text-5xl font-black text-pink-800 text-center mb-6 mt-4">æˆ‘æ˜¯èª°ï¼Ÿ</h1>
                            
                            <div className="grid grid-cols-2 gap-8 max-w-5xl mx-auto">
                                {students.map(student => (
                                    <button
                                        key={student.id}
                                        onClick={() => setSelectedStudentId(student.id)}
                                        className={`p-10 rounded-[2rem] shadow-xl border-b-[12px] active:translate-y-2 active:border-b-0 transition-all ${student.submitted ? 'bg-green-100 border-green-400' : 'bg-white border-pink-300'}`}
                                    >
                                        <div className="text-5xl font-bold text-gray-800">{student.name}</div>
                                        {student.submitted && <div className="mt-4 text-3xl font-bold text-green-700">å·²é€å‡º âœ…</div>}
                                    </button>
                                ))}
                            </div>
                        </div>
                    );
                } else {
                    const currentStudent = students.find(s => s.id === selectedStudentId);
                    if (!currentStudent) return <div>è¼‰å…¥ä¸­...</div>;
                    const isSubmitted = currentStudent.submitted;

                    return (
                        <div className="tablet-mode-container p-6 flex flex-col items-center">
                            <div className="w-full max-w-3xl flex justify-between items-center mb-8 mt-4">
                                <h2 className="text-5xl font-black text-pink-800">{currentStudent.name}çš„ä»»å‹™</h2>
                                <button onClick={() => setSelectedStudentId(null)} className="bg-gray-200 text-gray-700 px-8 py-4 rounded-full font-bold text-2xl shadow-md">è¿”å›</button>
                            </div>
                            
                            <div className="flex-1 w-full max-w-3xl space-y-8 relative">
                                {isSubmitted && (
                                    <div className="absolute inset-0 bg-white/90 z-10 rounded-[2.5rem] flex flex-col items-center justify-center backdrop-blur-sm border-8 border-green-200">
                                        <div className="text-8xl mb-6">âœ…</div>
                                        <div className="text-6xl font-bold text-green-700 mb-10">ç­”æ¡ˆå·²é€å‡ºï¼</div>
                                        <button 
                                            onClick={() => submitStudentData(currentStudent.id, false)}
                                            className="bg-gray-500 text-white px-10 py-5 rounded-full font-bold text-3xl shadow-lg hover:bg-gray-600"
                                        >
                                            ä¿®æ”¹ç­”æ¡ˆ
                                        </button>
                                    </div>
                                )}

                                {[{ key: 'eyes', icon: 'ğŸ‘€', text: 'æˆ‘æœ‰çœ‹ç´…ç¶ ç‡ˆ' }, { key: 'hand', icon: 'âœ‹', text: 'æˆ‘æƒ³èªªè©±æœ‰èˆ‰æ‰‹' }, { key: 'mouth', icon: 'ğŸ¤', text: 'åˆ¥äººèªªè©±æˆ‘å®‰éœ' }].map(item => (
                                    <div key={item.key} onClick={() => !isSubmitted && updateStudentCheck(currentStudent.id, item.key, currentStudent.checks[item.key])} className={`flex items-center p-8 bg-white rounded-[2rem] shadow-lg cursor-pointer transition-all border-l-[24px] active:scale-95 ${currentStudent.checks[item.key] ? 'border-green-500 bg-green-50' : 'border-gray-300'}`}>
                                        <div className={`w-24 h-24 rounded-2xl border-[6px] mr-8 flex items-center justify-center transition-colors flex-shrink-0 ${currentStudent.checks[item.key] ? 'bg-green-500 border-green-500' : 'border-gray-300'}`}>{currentStudent.checks[item.key] && <span className="text-6xl text-white font-bold">âœ“</span>}</div>
                                        <span className="text-7xl mr-8">{item.icon}</span><span className="text-5xl font-bold text-gray-700">{item.text}</span>
                                    </div>
                                ))}
                            </div>
                            
                            {!isSubmitted && (
                                <div className="mt-10 mb-12 w-full max-w-3xl">
                                    <button 
                                        onClick={() => submitStudentData(currentStudent.id, true)}
                                        className="w-full bg-pink-500 hover:bg-pink-600 text-white text-5xl font-black py-8 rounded-[2.5rem] shadow-2xl border-b-[12px] border-pink-700 active:translate-y-2 active:border-b-0 transition-all flex items-center justify-center gap-6"
                                    >
                                        <span>ğŸš€</span> ç¢ºèªé€å‡º
                                    </button>
                                </div>
                            )}
                        </div>
                    );
                }
            }

            const SlideContent = () => {
                switch(currentSlide) {
                    case 0: return (
                        <div className="content-area bg-blue-50">
                            <div className="text-[10rem] animate-bounce-slow mt-4">ğŸ¦</div>
                            <h1 className="text-8xl font-black text-blue-800 tracking-wider mb-8">ç¤¾æœƒæŠ€å·§èª²</h1>
                            <div className="bg-white px-12 py-6 rounded-3xl border-8 border-blue-300 shadow-xl mb-6"><h2 className="text-5xl font-bold text-gray-700">æµ£ç†Šçš„æˆ¿é–“èˆ‡èªªè©±è¦å‰‡</h2></div>
                            <p className="text-3xl text-gray-500 font-bold">æº–å‚™å¥½ä½ çš„è€³æœµå’Œçœ¼ç›äº†å—ï¼Ÿ</p>
                        </div>
                    );
                    case 1: return (
                        <div className="content-area bg-yellow-50 px-16">
                            <h2 className="text-6xl font-bold text-yellow-800 mb-12 border-b-8 border-yellow-200 pb-4">ä»Šå¤©çš„ä»»å‹™</h2>
                            <div className="flex-1 flex flex-col justify-center gap-8 w-full max-w-5xl">
                                <div className="flex items-center p-8 bg-white rounded-3xl shadow-lg border-l-[20px] border-blue-500 hover:scale-105 transition-transform"><span className="text-7xl mr-10">ğŸ“–</span><span className="text-5xl font-bold text-gray-700">1. è½ç¹ªæœ¬æ•…äº‹</span></div>
                                <div className="flex items-center p-8 bg-white rounded-3xl shadow-lg border-l-[20px] border-green-500 hover:scale-105 transition-transform"><span className="text-7xl mr-10">ğŸ²</span><span className="text-5xl font-bold text-gray-700">2. ç©ã€Œèªªè©±éŠæˆ²ã€</span></div>
                                <div className="flex items-center p-8 bg-white rounded-3xl shadow-lg border-l-[20px] border-red-500 hover:scale-105 transition-transform"><span className="text-7xl mr-10">â­</span><span className="text-5xl font-bold text-gray-700">3. é ˜å–çå‹µè²¼ç´™</span></div>
                            </div>
                        </div>
                    );
                    case 2: return (
                        <div className="content-area bg-white px-16">
                            <h2 className="text-6xl font-bold text-center text-gray-800 mb-12">æ•™å®¤è£¡çš„ç´…ç¶ ç‡ˆ</h2>
                            <div className="flex justify-center items-center gap-24 flex-1 w-full">
                                <div className={`flex flex-col items-center p-12 rounded-[4rem] transition-all duration-300 cursor-pointer ${lightStatus === 'red' ? 'bg-red-50 scale-110 border-8 border-red-400 shadow-2xl' : 'opacity-40 grayscale hover:opacity-70'}`} onClick={() => setLightStatus('red')}>
                                    <div className="w-56 h-56 rounded-full bg-red-500 shadow-xl flex items-center justify-center mb-8 border-8 border-white ring-8 ring-red-200"><span className="text-8xl">ğŸ‘‚</span></div>
                                    <h3 className="text-6xl font-black text-red-600 mb-4">ç´…ç‡ˆ</h3><p className="text-4xl font-bold text-gray-600 mb-2">è€³æœµæ‰“é–‹</p><p className="text-4xl font-bold text-gray-600">å˜´å·´æ‹‰æ‹‰éŠ</p>
                                </div>
                                <div className={`flex flex-col items-center p-12 rounded-[4rem] transition-all duration-300 cursor-pointer ${lightStatus === 'green' ? 'bg-green-50 scale-110 border-8 border-green-400 shadow-2xl' : 'opacity-40 grayscale hover:opacity-70'}`} onClick={() => setLightStatus('green')}>
                                    <div className="w-56 h-56 rounded-full bg-green-500 shadow-xl flex items-center justify-center mb-8 border-8 border-white ring-8 ring-green-200"><span className="text-8xl">ğŸ—£ï¸</span></div>
                                    <h3 className="text-6xl font-black text-green-600 mb-4">ç¶ ç‡ˆ</h3><p className="text-4xl font-bold text-gray-600 mb-2">ç¾åœ¨è¼ªåˆ°ä½ </p><p className="text-4xl font-bold text-gray-600">å¯ä»¥èªªè©±</p>
                                </div>
                            </div>
                        </div>
                    );
                    case 3: return (
                        <div className="content-area bg-indigo-50 px-16">
                            <h2 className="text-6xl font-bold text-indigo-900 mb-12">ç¾åœ¨æ˜¯ä»€éº¼ç‡ˆï¼Ÿ</h2>
                            <div className="flex items-center justify-center gap-20 w-full flex-1">
                                <div className="bg-white p-8 rounded-[3rem] shadow-2xl border-8 border-indigo-200 transform -rotate-2">
                                    <div className="relative">
                                        <img src="./room.png" alt="æµ£ç†Šçš„æˆ¿é–“" className="w-80 h-96 object-cover rounded-2xl mb-6 shadow-inner bg-gray-100" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'flex'; }} />
                                        <div className="w-80 h-96 bg-gray-200 hidden flex-col items-center justify-center rounded-2xl mb-6 text-gray-400 text-center p-4"><div className="text-center"><div className="text-6xl mb-4">ğŸ“š</div><div className="text-2xl font-bold">åœ–ç‰‡è®€å–å¤±æ•—<br/>room.png</div></div></div>
                                    </div>
                                    <p className="text-4xl text-center font-bold text-gray-700">è€å¸«åœ¨è¬›æ•…äº‹</p>
                                </div>
                                <div className="text-8xl font-bold text-indigo-300 animate-pulse">â¡ï¸</div>
                                <div className="flex flex-col items-center animate-bounce-slow">
                                    <div className="w-56 h-56 rounded-full bg-red-500 shadow-2xl flex items-center justify-center border-[12px] border-white ring-8 ring-red-200"><span className="text-8xl">ğŸ¤«</span></div>
                                    <p className="text-5xl font-bold text-red-600 mt-8 bg-white px-10 py-4 rounded-full shadow-xl border-4 border-red-100">ç¾åœ¨æ˜¯ç´…ç‡ˆ</p>
                                </div>
                            </div>
                        </div>
                    );
                    case 4: return (
                        <div className="content-area bg-orange-50 px-16">
                            <h2 className="text-6xl font-bold text-orange-800 mb-8 text-center">æˆ‘å¥½æƒ³èªªè©±ï¼Œæ€éº¼è¾¦ï¼Ÿ</h2>
                            <div className="flex-1 flex flex-col justify-center items-center gap-8 w-full">
                                <div className="bg-white px-16 py-8 rounded-[3rem] shadow-2xl border-8 border-orange-300 flex flex-col items-center cursor-pointer hover:scale-105 transition-transform">
                                    <span className="text-[8rem] mb-2 leading-none">âœ‹</span><h3 className="text-5xl font-black text-orange-600">ç­‰å¾…å¡</h3>
                                </div>
                                <div className="w-full max-w-4xl space-y-6">
                                    <div className="flex items-center text-4xl font-bold text-gray-700 bg-white/60 p-6 rounded-3xl"><span className="bg-orange-500 text-white w-12 h-12 text-3xl rounded-full flex items-center justify-center mr-6 shadow-md font-black flex-shrink-0">1</span>æŠŠã€Œç­‰å¾…å¡ã€èˆ‰é«˜é«˜</div>
                                    <div className="flex items-center text-4xl font-bold text-gray-700 bg-white/60 p-6 rounded-3xl"><span className="bg-orange-500 text-white w-12 h-12 text-3xl rounded-full flex items-center justify-center mr-6 shadow-md font-black flex-shrink-0">2</span>å˜´å·´é–‰é–‰ï¼Œçœ¼ç›çœ‹è€å¸«</div>
                                    <div className="flex items-center text-4xl font-bold text-gray-700 bg-white/60 p-6 rounded-3xl"><span className="bg-orange-500 text-white w-12 h-12 text-3xl rounded-full flex items-center justify-center mr-6 shadow-md font-black flex-shrink-0">3</span>è€å¸«é»é ­ï¼Œè®Šç¶ ç‡ˆå†èªªè©±</div>
                                </div>
                            </div>
                        </div>
                    );
                    case 5: return (
                        <div className="content-area bg-white px-16">
                            <h2 className="text-6xl font-bold text-center text-purple-800 mb-12">å¹«å¹«å°å…”å­ï¼</h2>
                            <div className="flex-1 flex items-center justify-center space-x-24 w-full">
                                <div className="relative group">
                                    <span className="text-[10rem] block transform group-hover:-translate-y-4 transition-transform duration-300">ğŸ°</span>
                                    <div className="absolute -top-20 -right-24 bg-white border-8 border-gray-800 rounded-3xl p-6 shadow-2xl w-80 z-10 bubble-bottom-left"><p className="text-2xl font-bold leading-relaxed">æˆ‘å‘Šè¨´ä½ å–”ï¼é‚£å€‹æµ£ç†Šå¾Œä¾†å°±...</p></div>
                                    <p className="text-center text-3xl font-bold mt-4 bg-purple-100 py-2 px-8 rounded-full text-purple-800">é˜¿ç™½ (ä¸€ç›´èªª)</p>
                                </div>
                                <div className="relative opacity-60">
                                    <span className="text-[10rem] block transform scale-x-[-1]">ğŸ°</span>
                                    <div className="absolute -top-8 -left-16 animate-pulse"><span className="text-7xl">ğŸ˜–</span></div>
                                    <p className="text-center text-3xl font-bold mt-4 bg-gray-200 py-2 px-8 rounded-full text-gray-600">åœŸåœŸ (æƒ³å®‰éœ)</p>
                                </div>
                            </div>
                            <div className="bg-purple-100 p-6 rounded-[2rem] text-center mt-8 max-w-4xl mx-auto border-8 border-purple-200 mb-8">
                                <p className="text-4xl font-bold text-purple-900 mb-2">é˜¿ç™½å¿˜è¨˜çœ‹ç´…ç¶ ç‡ˆäº†ï¼</p><p className="text-3xl text-purple-700 font-bold">èª°å¯ä»¥æ‹¿ã€Œç­‰å¾…å¡ã€æ•™æ•™ä»–ï¼Ÿ</p>
                            </div>
                        </div>
                    );
                    case 6: return (
                        <div className="content-area bg-cyan-50 px-16">
                            <h2 className="text-6xl font-bold text-cyan-800 mb-12">é€™æ˜¯èª°çš„ç™¼è¨€æ™‚é–“ï¼Ÿ</h2>
                            <div className="flex-1 flex flex-col justify-center items-center w-full">
                                <div className="bg-gradient-to-br from-gray-700 to-gray-900 p-8 rounded-full shadow-2xl mb-10 border-[10px] border-gray-300 transform hover:scale-110 transition-transform duration-500"><span className="text-[7rem] text-white">ğŸ¤</span></div>
                                <div className="bg-white p-8 rounded-[2rem] shadow-xl border-l-[24px] border-cyan-500 max-w-4xl w-full">
                                    <div className="grid grid-cols-2 gap-8 text-center">
                                        <div className="p-6 bg-green-50 rounded-2xl"><p className="text-3xl text-gray-500 mb-2">æœ‰æ‹¿ <span className="text-cyan-600 font-bold">éº¥å…‹é¢¨</span></p><p className="text-5xl font-black text-green-600">= ç¶ ç‡ˆ ğŸŸ¢</p></div>
                                        <div className="p-6 bg-red-50 rounded-2xl"><p className="text-3xl text-gray-500 mb-2">æ²’æœ‰æ‹¿çš„äºº</p><p className="text-5xl font-black text-red-600">= ç´…ç‡ˆ ğŸ”´</p></div>
                                    </div>
                                </div>
                                <p className="mt-10 text-4xl text-gray-600 font-bold bg-white/80 px-12 py-4 rounded-full border-4 border-cyan-200 shadow-lg">å¦‚æœä½ æƒ³æ‹¿éº¥å…‹é¢¨ï¼Œè¦å…ˆåšä»€éº¼ï¼Ÿ</p>
                            </div>
                        </div>
                    );
                    case 7: 
                        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(window.location.href + '?mode=student')}`;
                        return (
                            <div className="content-area bg-pink-50 relative px-8 py-4">
                                <h2 className="text-5xl font-bold text-pink-800 mb-6 text-center">å…¨ç­æŒ‘æˆ°è³½</h2>
                                {isOfflineMode && <div className="absolute top-4 left-4 text-red-500 text-xl font-bold bg-white p-3 rounded-xl shadow-lg border-2 border-red-200 z-50">âš ï¸ æœªè¨­å®š Firebase</div>}
                                {loadingError && (
                                    <div className="absolute top-20 left-4 flex gap-2 z-50">
                                        <div className="text-red-600 font-bold bg-white p-3 rounded-xl border-2 border-red-300 shadow-xl text-lg whitespace-pre-wrap max-w-md">{loadingError}</div>
                                        <button onClick={connectToFirebase} className="bg-red-500 text-white px-4 py-2 rounded-xl shadow-lg hover:bg-red-600 text-xl font-bold">é‡é€£</button>
                                    </div>
                                )}
                                
                                <button onClick={resetAllStudents} className="absolute top-4 right-4 bg-gray-200 text-gray-600 hover:bg-red-100 hover:text-red-500 px-6 py-2 rounded-xl text-xl font-bold z-50 shadow-md">é‡ç½®</button>

                                {students.length === 0 && !loadingError && (
                                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                                        <p className="text-gray-500 text-2xl font-bold mb-6">è³‡æ–™åº«ç›®å‰æ˜¯ç©ºçš„</p>
                                        <button onClick={() => initializeStudents()} className="bg-pink-500 text-white px-8 py-4 rounded-full shadow-xl font-bold text-2xl hover:bg-pink-600 transition-colors">
                                            é»æˆ‘åˆå§‹åŒ–å­¸ç”Ÿåå–®
                                        </button>
                                    </div>
                                )}

                                <div className="flex-1 w-full grid grid-cols-4 gap-6 align-content-start overflow-y-auto pb-32 px-4">
                                    {students.map(student => {
                                        const score = calculateScore(student.checks);
                                        const isDone = score === 3;
                                        return (
                                            <div key={student.id} className={`p-6 rounded-[2rem] shadow-lg border-b-[12px] transition-all flex flex-col items-center justify-center relative overflow-hidden h-64 ${isDone ? 'bg-yellow-100 border-yellow-400 scale-105' : 'bg-white border-pink-200'}`}>
                                                {!student.submitted ? (
                                                    <>
                                                        <div className="text-6xl mb-2 animate-pulse grayscale opacity-50">ğŸ¤”</div>
                                                        <h3 className="text-3xl font-bold text-gray-500 mb-2">{student.name}</h3>
                                                        <div className="text-2xl font-bold text-gray-400">ä½œç­”ä¸­...</div>
                                                    </>
                                                ) : (
                                                    <div className="stamp-animation flex flex-col items-center w-full">
                                                        <div className="text-5xl mb-2">{isDone ? 'ğŸ†' : 'ğŸ‘'}</div>
                                                        <h3 className="text-3xl font-bold text-gray-800 mb-2">{student.name}</h3>
                                                        <div className={`text-4xl font-black mb-4 ${isDone ? 'text-yellow-600' : 'text-pink-600'}`}>
                                                            é”æˆ {score} é …
                                                        </div>
                                                        <div className="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-200">
                                                            <div className={`h-4 rounded-full transition-all duration-500 ${isDone ? 'bg-yellow-500' : 'bg-pink-500'}`} style={{width: `${(score/3)*100}%`}}></div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>

                                {isLocalFile ? (
                                    <div className="absolute bottom-4 right-4 bg-white p-4 rounded-2xl shadow-xl border-4 border-red-200 flex flex-col items-center max-w-sm">
                                        <p className="font-bold text-red-600 text-xl mb-1">âš ï¸ ç„¡æ³•æƒæ</p>
                                        <p className="text-lg text-gray-600 text-center">æœ¬æ©Ÿæª”æ¡ˆ (file://) ç„¡æ³•é€£ç·š<br/>è«‹ä¸Šå‚³è‡³ç¶²è·¯</p>
                                    </div>
                                ) : (
                                    <div className="absolute bottom-4 right-4 bg-white p-4 rounded-3xl shadow-2xl flex items-center gap-6 border-4 border-pink-200">
                                        <img src={qrCodeUrl} alt="Scan" className="w-32 h-32" />
                                        <div className="text-left"><p className="font-bold text-gray-700 text-3xl">æƒæåŠ å…¥</p><p className="text-xl text-gray-500">å¹³æ¿æ¨¡å¼</p></div>
                                    </div>
                                )}
                            </div>
                        );
                    case 8: return (
                        <div className="content-area bg-yellow-100">
                            <div className="text-[12rem] animate-pulse drop-shadow-2xl">ğŸŒŸ</div>
                            <h2 className="text-8xl font-black text-yellow-600 tracking-wider mb-8">ä»»å‹™æˆåŠŸï¼</h2>
                            <p className="text-4xl font-bold text-gray-700 bg-white/60 px-12 py-4 rounded-full mb-8">ä½ å¯ä»¥å»é ˜çå‹µè²¼ç´™å›‰ï¼</p>
                            <div className="flex gap-8 mt-4">
                                <span className="text-8xl animate-bounce" style={{animationDelay: '0s'}}>ğŸ¦</span>
                                <span className="text-8xl animate-bounce" style={{animationDelay: '0.2s'}}>ğŸ°</span>
                                <span className="text-8xl animate-bounce" style={{animationDelay: '0.4s'}}>ğŸ¦Š</span>
                            </div>
                        </div>
                    );
                    default: return <div>Slide Error</div>;
                }
            };

            return (
                <div className="slide-wrapper">
                    <div className="slide-container">
                        <SlideContent />
                        {!isTabletMode && (
                            <>
                                <button onClick={prevSlide} disabled={currentSlide === 0} className="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/50 hover:bg-white text-gray-800 p-4 rounded-full shadow-lg disabled:opacity-0 transition-all backdrop-blur-sm z-10"><svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M15 19l-7-7 7-7" /></svg></button>
                                <button onClick={nextSlide} disabled={currentSlide === totalSlides - 1} className="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/50 hover:bg-white text-gray-800 p-4 rounded-full shadow-lg disabled:opacity-0 transition-all backdrop-blur-sm z-10"><svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M9 5l7 7-7 7" /></svg></button>
                                <div className="absolute bottom-4 right-6 bg-black/10 px-6 py-1 rounded-full text-gray-600 font-bold text-2xl backdrop-blur-sm">{currentSlide + 1} / {totalSlides}</div>
                            </>
                        )}
                        {!isTabletMode && currentSlide === 7 && isLocalFile && (
                            <button onClick={() => window.open(window.location.href + '?mode=student', '_blank')} className="absolute bottom-4 left-4 bg-pink-600 text-white font-bold p-3 rounded-xl shadow-lg hover:bg-pink-700 z-50 text-xl">é–‹å•Ÿå­¸ç”Ÿå¹³æ¿è¦–çª— (æ¸¬è©¦ç”¨)</button>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
