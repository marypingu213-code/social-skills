<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾æœƒæŠ€å·§èª²ï¼šæµ£ç†Šçš„æˆ¿é–“ (åŒæ­¥å„ªåŒ–ç‰ˆ)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            overflow: hidden; 
        }
        .slide-wrapper { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #e2e8f0; }
        .slide-container { width: 100%; height: 100%; background: white; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .content-area { flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; align-items: center; padding: 2rem 4rem; width: 100%; height: 100%; }
        .tablet-mode-container { width: 100vw; height: 100vh; background-color: #fce7f3; overflow-y: auto; padding: 2rem; }
        .animate-bounce-slow { animation: bounce 2s infinite; }
        
        /* ç¿»ç‰Œç‰¹æ•ˆ */
        .flip-card { perspective: 1000px; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 2rem; }
        .flip-card-back { transform: rotateY(180deg); }

        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase è¨­å®š
        const TEACHER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDhwu9YAyfMxZtC5BhGKzmVyxWdQ4qW3MM",
            authDomain: "social-89bcb.firebaseapp.com",
            projectId: "social-89bcb",
            storageBucket: "social-89bcb.firebasestorage.app",
            messagingSenderId: "638955050705",
            appId: "1:638955050705:web:aec1eb12e9142c9a7ad7f0",
            measurementId: "G-CG8V25F05H"
        };

        // ç°¡åŒ–è³‡æ–™åº«è·¯å¾‘ï¼Œç¢ºä¿åŒæ­¥ç©©å®š
        const COLLECTION_NAME = 'classroom_v4_sync'; 

        if (firebase.apps.length === 0) {
            firebase.initializeApp(TEACHER_FIREBASE_CONFIG);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        const STUDENT_DATA = [
            { id: 's1', name: 'ç‘€å®‰' }, { id: 's2', name: 'æ‰¿ç†™' },
            { id: 's3', name: 'æ›¸æ„·' }, { id: 's4', name: 'å²·ç¿°' },
            { id: 's5', name: 'ç¿ç©' }, { id: 's6', name: 'å®‡è»’' },
            { id: 's7', name: 'æ¥·å…ƒ' }, { id: 's8', name: 'å®ˆæ©' }
        ];

        const App = () => {
            const [currentSlide, setCurrentSlide] = useState(0);
            const [lightStatus, setLightStatus] = useState('red');
            const [user, setUser] = useState(null);
            const [students, setStudents] = useState([]);
            const [isTabletMode, setIsTabletMode] = useState(false);
            const [selectedStudentId, setSelectedStudentId] = useState(null);
            const [connectionStatus, setConnectionStatus] = useState("connecting");
            const [revealResults, setRevealResults] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            // 1. åˆå§‹åŒ–èº«åˆ†èˆ‡æ¨¡å¼
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('mode') === 'student') setIsTabletMode(true);

                auth.signInAnonymously()
                    .then(() => setConnectionStatus("connected"))
                    .catch(err => setConnectionStatus("disconnected"));

                const unsubscribe = auth.onAuthStateChanged(u => setUser(u));
                return () => unsubscribe();
            }, []);

            // 2. æ ¸å¿ƒåŒæ­¥é‚è¼¯ (å¤§é›»è¦–ç›£è½æ­¤è™•)
            useEffect(() => {
                if (!user) return;

                const unsubscribe = db.collection(COLLECTION_NAME)
                    .orderBy("order")
                    .onSnapshot((snapshot) => {
                        const data = [];
                        snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                        
                        if (data.length === 0) {
                            initializeDatabase();
                        } else {
                            setStudents(data);
                        }
                    }, (err) => {
                        console.error("Firestore Error:", err);
                        setConnectionStatus("disconnected");
                    });

                return () => unsubscribe();
            }, [user]);

            const initializeDatabase = async () => {
                const batch = db.batch();
                STUDENT_DATA.forEach((s, index) => {
                    const ref = db.collection(COLLECTION_NAME).doc(s.id);
                    batch.set(ref, {
                        name: s.name,
                        order: index,
                        checks: { eyes: false, hand: false, mouth: false },
                        submitted: false
                    });
                });
                await batch.commit();
            };

            // 3. å­¸ç”Ÿé€å‡ºè³‡æ–™ (åŒ…å«æ™‚é–“æˆ³è¨˜å¼·åˆ¶è§¸ç™¼é›»è¦–æ›´æ–°)
            const submitStudentData = async (studentId, status) => {
                setIsSubmitting(true);
                try {
                    await db.collection(COLLECTION_NAME).doc(studentId).update({
                        submitted: status,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (e) {
                    alert("é€å‡ºå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯ï¼");
                } finally {
                    setIsSubmitting(false);
                }
            };

            const updateCheck = async (studentId, key, current) => {
                await db.collection(COLLECTION_NAME).doc(studentId).update({
                    [`checks.${key}`]: !current
                });
            };

            const resetAll = async () => {
                if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰äººçš„é€²åº¦å—ï¼Ÿ")) return;
                setRevealResults(false);
                const batch = db.batch();
                students.forEach(s => {
                    batch.update(db.collection(COLLECTION_NAME).doc(s.id), {
                        submitted: false,
                        checks: { eyes: false, hand: false, mouth: false }
                    });
                });
                await batch.commit();
            };

            // --- è¦–åœ–çµ„ä»¶ ---
            const StatusBadge = () => (
                <div className="absolute top-6 right-6 z-50 bg-white/90 px-5 py-2 rounded-full shadow-md border">
                    <span className={connectionStatus === 'connected' ? "text-green-500 font-bold" : "text-red-500 font-bold"}>
                        {connectionStatus === 'connected' ? "â— é›²ç«¯é€£ç·šä¸­" : "â— æ–·ç·š"}
                    </span>
                </div>
            );

            if (isTabletMode) {
                if (!selectedStudentId) {
                    return (
                        <div className="tablet-mode-container">
                            <StatusBadge />
                            <h1 className="text-7xl font-black text-pink-800 text-center mb-12 mt-10">æˆ‘æ˜¯èª°ï¼Ÿ</h1>
                            <div className="grid grid-cols-2 gap-8 max-w-5xl mx-auto">
                                {students.map(s => (
                                    <button key={s.id} onClick={() => setSelectedStudentId(s.id)} className={`p-10 rounded-[2rem] border-b-[12px] active:translate-y-2 transition-all ${s.submitted ? 'bg-green-100 border-green-400' : 'bg-white border-pink-300'}`}>
                                        <div className="text-5xl font-bold">{s.name}</div>
                                        {s.submitted && <div className="text-2xl text-green-600 mt-2 font-bold">å·²é€å‡º</div>}
                                    </button>
                                ))}
                            </div>
                        </div>
                    );
                } else {
                    const s = students.find(x => x.id === selectedStudentId);
                    return (
                        <div className="tablet-mode-container flex flex-col items-center">
                            <div className="w-full flex justify-between items-center mb-10">
                                <h2 className="text-6xl font-black text-pink-800">{s.name}</h2>
                                <button onClick={() => setSelectedStudentId(null)} className="text-2xl font-bold bg-gray-200 px-6 py-3 rounded-xl">è¿”å›</button>
                            </div>
                            <div className="w-full max-w-4xl space-y-8">
                                {[{k:'eyes', t:'æˆ‘æœ‰çœ‹ç´…ç¶ ç‡ˆ', i:'ğŸ‘€'}, {k:'hand', t:'æˆ‘æƒ³èªªè©±æœ‰èˆ‰æ‰‹', i:'âœ‹'}, {k:'mouth', t:'åˆ¥äººèªªè©±æˆ‘å®‰éœ', i:'ğŸ¤'}].map(item => (
                                    <div key={item.k} onClick={() => !s.submitted && updateCheck(s.id, item.k, s.checks[item.k])} className={`flex items-center p-8 bg-white rounded-[2rem] shadow-lg border-l-[30px] ${s.checks[item.k] ? 'border-green-500' : 'border-gray-300'}`}>
                                        <span className="text-6xl mr-6">{item.i}</span>
                                        <span className="text-4xl font-bold text-gray-700">{item.t}</span>
                                        {s.checks[item.k] && <span className="ml-auto text-4xl">âœ…</span>}
                                    </div>
                                ))}
                            </div>
                            <button 
                                onClick={() => submitStudentData(s.id, !s.submitted)} 
                                className={`w-full max-w-4xl mt-12 py-10 rounded-[3rem] text-5xl font-black text-white shadow-xl ${s.submitted ? 'bg-gray-400' : 'bg-pink-500'}`}
                            >
                                {isSubmitting ? "å‚³é€ä¸­..." : s.submitted ? "ä¿®æ”¹ç­”æ¡ˆ" : "ğŸš€ ç¢ºèªé€å‡º"}
                            </button>
                        </div>
                    );
                }
            }

            // å¤§é›»è¦–æŠ•å½±ç‰‡é‚è¼¯
            const SlideContent = () => {
                switch(currentSlide) {
                    case 7: 
                        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(window.location.href + '?mode=student')}`;
                        return (
                            <div className="content-area bg-pink-50 w-full px-10">
                                <div className="flex justify-between items-center w-full mb-6">
                                    <h2 className="text-7xl font-black text-pink-800">å…¨ç­æŒ‘æˆ°è³½</h2>
                                    <div className="flex gap-4">
                                        <button onClick={() => setRevealResults(!revealResults)} className="bg-yellow-400 px-8 py-4 rounded-2xl text-3xl font-bold shadow-md">{revealResults ? 'ğŸ™ˆ éš±è—' : 'ğŸ‘€ æ­æ›‰'}</button>
                                        <button onClick={resetAll} className="bg-gray-200 px-8 py-4 rounded-2xl text-3xl font-bold">é‡ç½®</button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-4 gap-6 w-full flex-1 overflow-y-auto pb-20">
                                    {students.map(s => {
                                        const score = Object.values(s.checks).filter(Boolean).length;
                                        return (
                                            <div key={s.id} className="flip-card h-64">
                                                <div className={`flip-card-inner ${revealResults && s.submitted ? 'flipped' : ''}`}>
                                                    <div className={`flip-card-front shadow-lg border-b-8 ${s.submitted ? 'bg-green-100 border-green-400' : 'bg-white border-pink-200'}`}>
                                                        <div className="text-6xl mb-2">{s.submitted ? 'âœ…' : 'ğŸ¤”'}</div>
                                                        <div className="text-4xl font-bold">{s.name}</div>
                                                    </div>
                                                    <div className="flip-card-back bg-yellow-100 shadow-lg border-b-8 border-yellow-400">
                                                        <div className="text-6xl mb-2">{score === 3 ? 'ğŸ†' : 'ğŸ‘'}</div>
                                                        <div className="text-4xl font-black">{s.name}</div>
                                                        <div className="text-5xl font-black text-pink-600">{score}/3</div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="absolute bottom-4 right-4 bg-white p-4 rounded-2xl shadow-xl flex items-center gap-4 border-4 border-pink-100">
                                    <img src={qrUrl} className="w-32 h-32" />
                                    <div><p className="font-bold text-2xl">æƒæåŠ å…¥</p><p className="text-lg text-gray-500">å¹³æ¿æ¨¡å¼</p></div>
                                </div>
                            </div>
                        );
                    case 0: return <div className="content-area bg-blue-50"><div className="text-[15rem] animate-bounce-slow">ğŸ¦</div><h1 className="text-9xl font-black text-blue-800">ç¤¾æœƒæŠ€å·§èª²</h1><p className="text-4xl text-gray-500">æµ£ç†Šçš„æˆ¿é–“èˆ‡èªªè©±è¦å‰‡</p></div>;
                    default: return <div className="content-area"><h2 className="text-6xl font-bold text-gray-400">è«‹æŒ‰ç®­é ­åˆ‡æ›æŠ•å½±ç‰‡</h2><p className="text-3xl mt-4">åˆ°ç¬¬ 8 é å¯çœ‹åˆ°æˆç¸¾</p></div>;
                }
            };

            return (
                <div className="slide-wrapper">
                    <StatusBadge />
                    <div className="slide-container">
                        <SlideContent />
                        {!isTabletMode && (
                            <div className="absolute bottom-6 w-full flex justify-center gap-20">
                                <button onClick={() => setCurrentSlide(Math.max(0, currentSlide-1))} className="bg-white/80 p-6 rounded-full shadow-lg text-4xl">â¬…ï¸</button>
                                <div className="text-3xl font-bold flex items-center">{currentSlide + 1} / 9</div>
                                <button onClick={() => setCurrentSlide(Math.min(8, currentSlide+1))} className="bg-white/80 p-6 rounded-full shadow-lg text-4xl">â¡ï¸</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
